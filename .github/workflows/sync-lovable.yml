name: Sync Lovable Changes to Code

on:
  workflow_dispatch: # Button to click manually after vibe coding

jobs:
  extract-schema:
    name: Detect Drift in Training
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          ref: training # Checkout the training branch

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to Training DB
        run: supabase link --project-ref ${{ secrets.TRAINING_PROJECT_ID }} --password ${{ secrets.TRAINING_DB_PASSWORD }}

      - name: Generate Migration
        id: diff
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          MIGRATION_NAME="${TIMESTAMP}_lovable_sync"
          
          # This runs successfully on GitHub Actions (Docker is available)
          # We purposefully exclude auth/storage schemas to avoid permission errors
          supabase db diff --schema public -f $MIGRATION_NAME
          
          # Check if file exists and is not empty
          FILE_PATH="supabase/migrations/${TIMESTAMP}_lovable_sync.sql"
          if [ -s "$FILE_PATH" ]; then
            echo "New changes detected."
            echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected."
            echo "has_changes=false" >> $GITHUB_OUTPUT
            # Cleanup empty file if created
            rm -f "$FILE_PATH" || true
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Commit and Push
        if: steps.diff.outputs.has_changes == 'true'
        run: |
          git config --global user.name "NuLedger Bot"
          git config --global user.email "bot@nuledger.com"
          git add ${{ steps.diff.outputs.file_path }}
          git commit -m "chore: sync db changes from Lovable"
          git push origin training
